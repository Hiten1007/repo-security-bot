name: "Scan: Dockle"

on:
  push:
  pull_request:
  workflow_call:

jobs:
  dockle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Dockerfile
        id: detect
        run: |
          if [ -f "Dockerfile" ]; then
            echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
          elif [ -f "Dockerfile.txt" ]; then
            echo "dockerfile=Dockerfile.txt" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image (if Dockerfile exists)
        if: steps.detect.outputs.dockerfile != ''
        run: |
          docker build -t security-image:latest -f "${{ steps.detect.outputs.dockerfile }}" . || true

      - name: Create reports directory
        run: mkdir -p reports

      - name: Pull Dockle
        run: docker pull goodwithtech/dockle:latest || true

      - name: Run Dockle scan
        continue-on-error: true
        run: |
          if [ "${{ steps.detect.outputs.dockerfile }}" = "" ]; then
            echo '{"message":"No Dockerfile found, skipped Dockle scan."}' > reports/dockle.json
          else
            # JSON output
            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v "${{ github.workspace }}/reports":/reports \
              goodwithtech/dockle:latest \
              -f json -o /reports/dockle.json security-image:latest || true

            # Text output (human readable)
            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              goodwithtech/dockle:latest security-image:latest \
              > reports/dockle.txt || true
          fi

          if [ ! -s reports/dockle.json ]; then
            echo '{"message":"Dockle produced no output."}' > reports/dockle.json
          fi

      - name: Generate Dockle Markdown Summary
        run: |
          JSON="reports/dockle.json"
          OUT="reports/dockle.md"

          echo "# ðŸ³ Dockle Scan Summary" > "$OUT"
          echo "" >> "$OUT"

          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get install -y jq
          fi

          # Summary table
          echo "## ðŸ”Ž Summary" >> "$OUT"
          echo "" >> "$OUT"
          echo "| Fatal | Warn | Info | Skip | Pass |" >> "$OUT"
          echo "|------|------|------|------|------|" >> "$OUT"

          jq -r '
            .summary |
            "| \(.fatal) | \(.warn) | \(.info) | \(.skip) | \(.pass) |"
          ' "$JSON" >> "$OUT"

          echo "" >> "$OUT"
          echo "## ðŸ“‹ Detailed Findings" >> "$OUT"
          echo "" >> "$OUT"

          jq -r '
            .details[] |
            "### \(.code) - \(.title)\n- **Level:** \(.level)\n- **Alerts:**\n" +
            ( .alerts | map("  - " + .) | join("\n") ) + "\n"
          ' "$JSON" >> "$OUT"

      - name: Upload Dockle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dockle-report
          path: reports/
