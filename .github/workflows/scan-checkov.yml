name: "Scan: Checkov"
on:
  push:
    branches: [main, master, develop]
  pull_request:
  workflow_dispatch:  # Manual trigger
  workflow_call:      # Can also be called by other workflows
jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
      
      - name: Install Checkov
        run: pip install --upgrade pip checkov
      
      - name: Debug - Show Workspace Contents
        run: |
          echo "=== Current Directory ==="
          pwd
          echo ""
          echo "=== All Files (tree view) ==="
          find . -type f -not -path '*/\.git/*' | head -50
          echo ""
          echo "=== Terraform Files ==="
          find . -name "*.tf" -type f -exec echo "Found: {}" \; -exec cat {} \;
          echo ""
          echo "=== Checkov Version ==="
          checkov --version
          echo ""
          echo "=== Test Checkov directly on file if it exists ==="
          if [ -f "main.tf" ]; then
            echo "main.tf exists, testing direct scan:"
            checkov -f main.tf --compact || echo "Direct scan failed"
          else
            echo "main.tf NOT FOUND in $(pwd)"
          fi
      
      - name: Run Checkov and Produce Clean JSON
        continue-on-error: true
        run: |
          mkdir -p reports
          
          # Count terraform files
          TF_COUNT=$(find . -name "*.tf" -type f -not -path '*/\.git/*' | wc -l)
          echo "Found $TF_COUNT .tf files"
          
          if [ "$TF_COUNT" -eq 0 ]; then
            echo "ERROR: No Terraform files found in workspace!"
            echo "[]" > reports/raw.json
          else
            echo "Running Checkov scan on root directory..."
            
            # Use --output-file-path to write directly to file
            # Checkov will create results_json.json in the reports directory
            checkov --directory . --framework terraform --output json \
              --output-file-path reports 2>&1 || true
            
            echo ""
            echo "=== Files created in reports/ ==="
            ls -la reports/
            echo ""
            
            # Checkov creates results_json.json by default with --output-file-path
            if [ -f "reports/results_json.json" ]; then
              echo "Found results_json.json ($(wc -c < reports/results_json.json) bytes)"
              cp reports/results_json.json reports/raw.json
              
              # Show first part of the file
              echo "=== First 100 lines of results ==="
              head -100 reports/raw.json
              echo ""
            else
              echo "ERROR: results_json.json not created!"
              echo "Trying direct file scan as fallback..."
              checkov --file main.tf --framework terraform --output json \
                --output-file-path reports 2>&1 || true
              
              if [ -f "reports/results_json.json" ]; then
                cp reports/results_json.json reports/raw.json
              else
                echo "[]" > reports/raw.json
              fi
            fi
          fi
          
          # Validate JSON before processing
          if jq empty reports/raw.json 2>/dev/null; then
            echo "âœ“ Valid JSON detected"
            
            # Check structure and normalize
            RAW_TYPE=$(jq -r 'type' reports/raw.json)
            echo "JSON type: $RAW_TYPE"
            
            if [ "$RAW_TYPE" = "object" ]; then
              echo "Wrapping object in array..."
              jq '[.]' reports/raw.json > reports/checkov_results.json
            elif [ "$RAW_TYPE" = "array" ]; then
              echo "Already an array, copying..."
              cp reports/raw.json reports/checkov_results.json
            else
              echo "Unexpected type, wrapping anyway..."
              jq -s '.' reports/raw.json > reports/checkov_results.json
            fi
          else
            echo "âœ— Invalid JSON detected, using empty array"
            echo "[]" > reports/checkov_results.json
          fi
          
          # Show final results summary
          echo ""
          echo "=== Final Results Summary ==="
          jq -r 'if type=="array" then 
                   if length == 0 then "No results" 
                   else "Found \(length) result block(s)" 
                   end
                 elif type=="object" then 
                   "Single object result (check_type: \(.check_type // "unknown"))"
                 else 
                   "Unexpected format"
                 end' reports/checkov_results.json
      
      - name: Generate Pretty Markdown Report
        run: |
          echo "## ðŸ— Checkov IaC Security Report" > reports/checkov.md
          echo "" >> reports/checkov.md
          
          # If JSON array is empty â†’ no findings
          if jq -e 'length == 0' reports/checkov_results.json > /dev/null; then
            echo "âœ… *No misconfigurations found (or no IaC files detected).*" >> reports/checkov.md
            exit 0
          fi
          
          # Loop through each scan block
          jq -c '.[]' reports/checkov_results.json | while read item; do
            TYPE=$(echo "$item" | jq -r '.check_type // "unknown"')
            FAILED=$(echo "$item" | jq -r '.summary.failed // 0')
            PASSED=$(echo "$item" | jq -r '.summary.passed // 0')
            
            echo "### ðŸ›  $TYPE Scan" >> reports/checkov.md
            echo "- ðŸ”´ **FAILED:** $FAILED" >> reports/checkov.md
            echo "- ðŸŸ¢ **PASSED:** $PASSED" >> reports/checkov.md
            echo "" >> reports/checkov.md
            
            if [ "$FAILED" -gt 0 ]; then
              echo "#### âš  Issues Found" >> reports/checkov.md
              echo "$item" | jq -r '
                .results.failed_checks[]? |
                "- ðŸ”´ **\(.check_id): \(.check_name)**\n  - **Resource:** `\(.resource)`\n  - **File:** `\(.file_path):\(.file_line_range[0])`\n  - **Guideline:** \(.guideline // "N/A")\n"
              ' >> reports/checkov.md
              echo "" >> reports/checkov.md
            fi
            echo "---" >> reports/checkov.md
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: reports/
