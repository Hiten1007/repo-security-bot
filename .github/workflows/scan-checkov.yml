name: "Scan: Checkov"
on:
  workflow_call:
jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Checkov
        run: pip install --upgrade pip checkov
      
      - name: Run Checkov and Produce Clean JSON
        continue-on-error: true
        run: |
          mkdir -p reports
          
          # Run Checkov - removed --quiet and 2>/dev/null to see actual output
          checkov -d . --framework terraform -o json --no-guide \
            > reports/raw.json || echo "[]" > reports/raw.json
          
          # Normalize: if raw.json is an object â†’ wrap into an array
          jq 'if type=="object" then [.] else . end' reports/raw.json \
            > reports/checkov_results.json
          
          # Debug output
          echo "Checkov scan completed. Results:"
          jq 'if length == 0 then "No results" else "Found \(length) result block(s)" end' reports/checkov_results.json
      
      - name: Generate Pretty Markdown Report
        run: |
          echo "## ðŸ— Checkov IaC Security Report" > reports/checkov.md
          echo "" >> reports/checkov.md
          
          # If JSON array is empty â†’ no findings
          if jq -e 'length == 0' reports/checkov_results.json > /dev/null; then
            echo "âœ… *No misconfigurations found (or no IaC files detected).*" >> reports/checkov.md
            exit 0
          fi
          
          # Loop through each scan block
          jq -c '.[]' reports/checkov_results.json | while read item; do
            TYPE=$(echo "$item" | jq -r '.check_type // "unknown"')
            FAILED=$(echo "$item" | jq -r '.summary.failed // 0')
            PASSED=$(echo "$item" | jq -r '.summary.passed // 0')
            
            echo "### ðŸ›  $TYPE Scan" >> reports/checkov.md
            echo "- ðŸ”´ **FAILED:** $FAILED" >> reports/checkov.md
            echo "- ðŸŸ¢ **PASSED:** $PASSED" >> reports/checkov.md
            echo "" >> reports/checkov.md
            
            if [ "$FAILED" -gt 0 ]; then
              echo "#### âš  Issues Found" >> reports/checkov.md
              echo "$item" | jq -r '
                .results.failed_checks[]? |
                "- ðŸ”´ **\(.check_id): \(.check_name)**\n  - **Resource:** `\(.resource)`\n  - **File:** `\(.file_path):\(.file_line_range[0])`\n  - **Guideline:** \(.guideline // "N/A")\n"
              ' >> reports/checkov.md
              echo "" >> reports/checkov.md
            fi
            echo "---" >> reports/checkov.md
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: reports/
