name: "Scan: Nuclei (Localhost)"

on:
  workflow_call:

jobs:
  dast-local:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. BUILD the App
      - name: Build Docker Image
        run: docker build -t my-app:test .

      # 2. RUN the App
      - name: Start Container
        run: |
          docker run -d -p 3000:3000 --name test-container my-app:test
          
          echo "Waiting for app to start on localhost:3000..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… App is up!"
              break
            fi
            sleep 1
          done

      # âš ï¸ NEW STEP: Create the directory BEFORE the scan
      - name: Create reports directory
        run: mkdir -p reports

      # 3. ATTACK with Nuclei
      - name: Run Nuclei DAST Scan
        uses: projectdiscovery/nuclei-action@main
        with:
          target: "http://localhost:3000"
          # Now this will work because 'reports/' exists
          flags: "-tags cve,misconfig,exposure,token -jsonl -o reports/nuclei.json"

      # 4. Parse Report
      - name: Generate Report
        if: always()
        run: |
          # No need to mkdir here anymore, but safe to keep
          echo "## â˜¢ï¸ Nuclei DAST Report" > reports/nuclei.md
          
          if [ ! -s reports/nuclei.json ]; then
             echo "âœ… **No vulnerabilities found (or scan failed to connect).**" >> reports/nuclei.md
          else
             jq -s '.' reports/nuclei.json > reports/clean.json
             COUNT=$(jq 'length' reports/clean.json)
             
             if [ "$COUNT" == "0" ]; then
                echo "âœ… **No vulnerabilities found.**" >> reports/nuclei.md
             else
                echo "Found **$COUNT** issues on Local Build." >> reports/nuclei.md
                echo "" >> reports/nuclei.md
                echo "### ðŸ” Top Findings" >> reports/nuclei.md
                echo "| Severity | Name | Path |" >> reports/nuclei.md
                echo "| :--- | :--- | :--- |" >> reports/nuclei.md
                jq -r '.[] | "| **\(.info.severity)** | \(.info.name) | \(.matched_at) |"' reports/clean.json | head -n 10 >> reports/nuclei.md
             fi
          fi